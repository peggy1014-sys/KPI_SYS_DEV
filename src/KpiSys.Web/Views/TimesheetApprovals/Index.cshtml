@model KpiSys.Web.Models.TimesheetApprovalListViewModel
@{
    ViewData["Title"] = "待審核工時";
    var returnUrl = Context.Request.Path + Context.Request.QueryString;
}

<div class="d-flex align-items-center mb-3">
    <div>
        <h1 class="h3 mb-0">待審核工時</h1>
        <p class="text-muted mb-0">僅顯示已提交的工時，可依專案、員工與日期範圍篩選</p>
    </div>
</div>

@if (TempData["Message"] is string message)
{
    <div class="alert alert-info">@message</div>
}
@if (TempData["Error"] is string error)
{
    <div class="alert alert-danger">@error</div>
}

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">專案</label>
                <select name="ProjectCode" class="form-select">
                    <option value="">全部</option>
                    @foreach (var project in Model.Projects)
                    {
                        if (project.Code == Model.Filter.ProjectCode)
                        {
                            <option value="@project.Code" selected="selected">@project.Code - @project.Name</option>
                        }
                        else
                        {
                            <option value="@project.Code">@project.Code - @project.Name</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">員工</label>
                <select name="EmployeeId" class="form-select">
                    <option value="">全部</option>
                    @foreach (var emp in Model.Employees)
                    {
                        if (Model.Filter.EmployeeId == emp.Id)
                        {
                            <option value="@emp.Id" selected="selected">@emp.EmployeeNo - @emp.Name</option>
                        }
                        else
                        {
                            <option value="@emp.Id">@emp.EmployeeNo - @emp.Name</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">開始日期</label>
                <input type="date" name="StartDate" value="@Model.Filter.StartDate?.ToString("yyyy-MM-dd")" class="form-control" />
            </div>
            <div class="col-md-3">
                <label class="form-label">結束日期</label>
                <input type="date" name="EndDate" value="@Model.Filter.EndDate?.ToString("yyyy-MM-dd")" class="form-control" />
            </div>
            <div class="col-12 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">套用篩選</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table align-middle mb-0">
            <thead>
                <tr>
                    <th>員工</th>
                    <th>日期</th>
                    <th>專案</th>
                    <th class="text-end">工時</th>
                    <th class="text-end">加班</th>
                    <th>提交時間</th>
                    <th>備註</th>
                    <th class="text-center">審核</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Entries.Any())
                {
                    <tr><td colspan="8" class="text-center text-muted">目前沒有待審核工時</td></tr>
                }
                else
                {
                    foreach (var item in Model.Entries)
                    {
                        <tr>
                            <td>
                                <div class="fw-semibold">@item.EmployeeName</div>
                                <div class="text-muted small">@item.EmployeeOrg</div>
                            </td>
                            <td>@item.WorkDate:yyyy/MM/dd</td>
                            <td>
                                <div class="fw-semibold">@item.ProjectName</div>
                                <div class="text-muted small">@item.ProjectCode</div>
                            </td>
                            <td class="text-end">@item.Hours</td>
                            <td class="text-end">@item.OvertimeHours</td>
                            <td>@(item.SubmittedAt?.ToString("yyyy/MM/dd HH:mm") ?? "-")</td>
                            <td>@(string.IsNullOrWhiteSpace(item.ApprovalRemarks) ? "-" : item.ApprovalRemarks)</td>
                            <td class="text-center">
                                <form method="post" class="d-flex gap-2 align-items-center flex-wrap" asp-action="Approve" asp-route-id="@item.Id">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="returnUrl" value="@returnUrl" />
                                    <input type="text" name="remarks" class="form-control form-control-sm" placeholder="備註（駁回必填）" />
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-sm btn-success">批准</button>
                                        <button type="submit" class="btn btn-sm btn-outline-danger" formaction="@Url.Action("Reject", new { id = item.Id })">駁回</button>
                                    </div>
                                </form>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>
